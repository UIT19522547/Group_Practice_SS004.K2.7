#include<iostream>
#include<Windows.h>
#include<conio.h>
#include<cstdlib>
#include<time.h>
#include<fstream>
#include<stdlib.h>
#define KB_UP 72
#define KB_DOWN 80
#define KB_LEFT 75
#define KB_RIGHT 77
#define KB_ESCAPE 27
#define width 60
#define height 20
#pragma execution_character_set( "utf-8" )
//Tạo thức ăn cho rắn -> Tạo 1 hàm đếm cho 1 điều kiện nhất định để thức ăn xuất hiện
//Lưu trữ điểm: Tạo 1 file lưu trữ tên người chơi và điểm số sau mỗi màn để tạo bảng xếp hạng cho 3 người cao nhất!

using namespace std;

//source: blogkhanhtoan.wordpress.com/2016/03/07/mot-so-ham-mo-rong-trong-cc/
//dùng hàm xóa màn hình kết hợp system("cls") -> vẽ khung không bị giựt
void XoaManHinh() {
	HANDLE hStdOut;
	CONSOLE_SCREEN_BUFFER_INFO csbi;
	DWORD count;
	DWORD cellCount=0;
	COORD homeCoords = { 0,0 };
	hStdOut = GetStdHandle(STD_OUTPUT_HANDLE);
	if (hStdOut == INVALID_HANDLE_VALUE) return;
	//Lấy số lượng ô trong bộ nhớ đệm hiện tại
	if (!GetConsoleScreenBufferInfo(hStdOut, &csbi))
		cellCount = csbi.dwSize.X * csbi.dwSize.Y;
	//Lấp đầy bộ nhớ đệm với khoảng trắng
	if (!FillConsoleOutputCharacter(hStdOut, (TCHAR)' ',
		cellCount, homeCoords, &count)) return;
	//Lấp đầy bộ nhớ đệm với màu và thuộc tính hiện tại
	if (!FillConsoleOutputAttribute(hStdOut, csbi.wAttributes
		, cellCount, homeCoords, &count)) return;
	//Di chuyển con trỏ về nhà
	SetConsoleCursorPosition(hStdOut, homeCoords);
}

void DuaConTroVeDau()
{
	HANDLE hConsole = GetStdHandle(STD_OUTPUT_HANDLE);
	COORD pos = { 0, 0 };
	SetConsoleCursorPosition(hConsole, pos);
}

void gotoXY(int column, int line) {
	COORD coord;
	coord.X = column;
	coord.Y = line;
	SetConsoleCursorPosition(GetStdHandle(STD_OUTPUT_HANDLE), coord);
}


void setTextColor(int color)
{
	SetConsoleTextAttribute(GetStdHandle(STD_OUTPUT_HANDLE), color);
}
//0 = Black       8 = Gray
//1 = Blue        9 = Light Blue
//2 = Green       10 = Light Green
//3 = Aqua        11 = Light Aqua
//4 = Red         12 = Light Red
//5 = Purple      13 = Light Purple
//6 = Yellow      14 = Light Yellow
//7 = White       15 = Bright White

struct Point {
	int x;
	int y;
};

class BACKGROUND {
public:
	void veKhung() {
		int j = 0;
		int i = 0;
		setTextColor(15);
		for (i = 0; i <= width ; i += 2) {
			gotoXY(i, j);
			cout << "= ";
		}
		i = width;
		for (j = 1; j <= height; j++) {
			gotoXY(i, j);
			cout << "=";
		}
		i = 0;
		for (j = 1; j <= height; j++) {
			gotoXY(i, j);
			cout << "=";
		}
		j = height ;
		for (i = 0; i <= width; i+=2) {
			gotoXY(i, j);
			cout << "= ";
		}
		setTextColor(14);

	}
	void drawFood(Point &F) {
		gotoXY(F.x, F.y);
		setTextColor(12);
		cout << "X";
		setTextColor(14);
		DuaConTroVeDau();
	}
	void drawScore(long score)
	{
		gotoXY(width + 5, 5);
		cout << "Điểm số: " << score;
		DuaConTroVeDau();
	}
};


class INTRODUCTION
{
public:
	void ChuThich(bool i) // 1-xuyên tường, 2-có tường 
	{
		system("color 0E");
		for (int j = 1; j < height; j += 2)
		{
			gotoXY(0, j);
			cout << "/";
			gotoXY(0, j + 1);
			cout << "\\";
			gotoXY(width, j);
			cout << "/";
			gotoXY(width, j - 1);
			cout << "\\";
		}
		for (int i = 0; i < width; i++)
		{
			gotoXY(i, height);
			cout << "-";
		}
		for (int i = 1; i <= width; i++)
		{
			gotoXY(i, 0);
			cout << "-";
		}
		gotoXY(2, 2);
		cout << "+ Hướng dẫn:";
		string s;
		gotoXY(2, 4);
		cout << "  Đây là trò chơi Con rắn. Trong trò chơi này, bạn phải ";
		gotoXY(2, 5);
		cout << "di chuyển con rắn trong một khu vực nhất định để thu thập ";
		gotoXY(2, 6);
		cout << "thức ăn. Bạn thu được càng nhiều thức ăn thì rắn sẽ càng ";
		gotoXY(2, 7);
		cout << "dài ra và điểm số sẽ càng tăng.";
		if(i==1) //xuyên tường
		{
			gotoXY(2, 8);
			cout << "  Ở chế độ xuyên tường, bạn sẽ thua cuộc nếu như để cho rắn ";
			gotoXY(2, 9);
			cout << "tự cắn vào bất kì phần nào trên thân nó.";
			gotoXY(2, 11);
			cout << "+ Chú thích:";
			gotoXY(5, 13);
			setTextColor(10);
			cout << "OOOOO";
			setTextColor(14);
			cout << ": rắn";
			gotoXY(width / 2 + 5, 13);
			setTextColor(12);
			cout << "X";
			setTextColor(14);
			cout << ": thức ăn";
			gotoXY(5, 15);
		}
		else if (i==0)
		{
			gotoXY(2, 8);
			cout << "  Ở chế độ không xuyên tường, bạn sẽ thua cuộc nếu như";
			gotoXY(2, 9);
			cout << "để cho rắn va vào tường hoặc tự cắn vào bất kì phần nào";
			gotoXY(2, 10);
			cout << "trên thân nó.";
			gotoXY(2, 12);
			cout << "+ Chú thích:";
			gotoXY(5, 14);
			setTextColor(10);
			cout << "OOOOO";
			setTextColor(14);
			cout<<": rắn";
			gotoXY(width / 2 + 5, 14);
			setTextColor(12);
			cout << "X";
			setTextColor(14);
			cout << ": thức ăn";
			gotoXY(5, 15);
			setTextColor(7);
			cout << "= = =";
			setTextColor(14);
			cout << ": tường";
			
		}
		DuaConTroVeDau();
		
		
	}
	int XuatChuThich(bool i) // trả về 1 là zô hàm play game, 0 là quay về menu 
	{
		int k = 2;	
		system("cls");
		ChuThich(i);
		char ch=NULL;
		while (ch!=13)
		{
			switch (k)
			{
			case 1:	
				gotoXY(9, 18);
				setTextColor(10);
				cout << "Quay lại";
				setTextColor(14);
				gotoXY(42, 18);
				cout << "Chơi";
				DuaConTroVeDau();
				ch = _getch();
				if (ch == KB_RIGHT)
					k = 2;
				if (ch == 13)
				{
					system("color 0F");
					return 0;
				}
				break;
			case 2:
				gotoXY(9, 18);	
				cout << "Quay lại";
				gotoXY(42, 18);
				setTextColor(10);
				cout << "Chơi";
				setTextColor(14);
				DuaConTroVeDau();
				ch = _getch();
				if (ch == KB_LEFT)
					k = 1;
				if (ch == 13)
				{
					system("color 0F");
					return 1;
				}
				break;
			}
		}
	}
};

class SNACK {
protected:
	Point ran[100];
	int doDai;
	int direction;
public:
	SNACK() {
		direction = 4;
		doDai = 3;
		ran[0].x = 10;
		ran[0].y = 10;
		ran[1].x = 11;
		ran[1].y = 10;
		ran[2].x = 12;
		ran[2].y = 10;
	}
	void Ve() {
		setTextColor(10);
		for (int i = 0; i < doDai; i++) {
			
			gotoXY(ran[i].x, ran[i].y);
			cout << "O";
		}
		setTextColor(14);
	}
	void Move() {
		for (int i = doDai - 1; i > 0; i--) {
			ran[i] = ran[i-1];
		}
		if (direction == 1) {
			ran[0].y -= 1;
		}
		else if (direction == 2) {
			ran[0].y += 1;
		}
		else if (direction == 3) {
			ran[0].x -= 1;
		}
		else {
			ran[0].x += 1;
		}
	}
	void setDirection(int direct) {
		if (ran[0].x == ran[1].x && ran[0].y > ran[1].y && direct == 1);
		else if (ran[0].x == ran[1].x && ran[0].y < ran[1].y && direct == 2);
		else if (ran[0].y == ran[1].y && ran[0].x > ran[1].x && direct == 3);
		else if (ran[0].y == ran[1].y && ran[0].x < ran[1].x && direct == 4);
		else
			direction = direct;
	}
	//kiểm tra xem con rắn có tự đụng thân không
	bool checkCollision() {
		for (int i = 1; i <doDai ; i++) {
			if ((ran[0].x == ran[i].x && ran[0].y == ran[i].y)) {
				return true;
			}
		}
		return false;
	}
	//Kiểm tra xem con rắn có đụng trúng khung hay không
	//Sử dụng hàm này khi chọn chế độ chơi không xuyên qua khung
	bool checkFrameConllision() {
		if (ran[0].x == 0 || ran[0].y == 0 || ran[0].x == width || ran[0].y == height)
			return true;
		return false;
	}
	//kiểm tra thức ăn có xuất hiện ở chỗ thân con rắn hiện tại hay không
	bool checkFoodCollision(Point F) {
		for (int i = 1; i < doDai; i++) {
			if (ran[i].x == F.x && ran[i].y == F.y)
				return true;
		}
		return false;
	}
	//Cho rắn đi xuyên tường
	void goThroughWall() {
		//di chuyển đầu rắn sang phía bên không gian ngược lại
		if (direction == 1) {
			ran[0].y = height-1;
		}
		else if (direction == 2) {
			ran[0].y = 1;
		}
		else if (direction == 3) {
			ran[0].x = width-1;
		}
		else {
			ran[0].x = 1;
		}
	}
	//Kiểm tra xem con rắn có ăn thức ăn hay chưa?
	bool ateFood(Point F) {
		if (ran[0].x == F.x && ran[0].y == F.y)
			return true;
		return false;
	}
	//Tăng độ dài của con rắn sau khi ăn mồi
	void growLength(Point F) {
		doDai++;
		for (int i = doDai - 1; i > 0; i--) {
			ran[i] = ran[i - 1];
		}
		ran[0] = F;
	}
};

void PlayGame(bool xuyenTuong,int doKho) {
	srand(time(NULL));
	int KB_CODE = 0;
	//Mặc định hướng của con rắn ban đầu là đi qua phải
	int huong = 4;
	//Vừa vào trò chơi yêu cầu người chơi chọn độ khó: dễ - trung bình - khó - siêu khó;
	int speed=500;
	//Khai báo + tự động khởi tạo background và con rắn
	SNACK S;
	BACKGROUND B;

	S.Move(); //Lần đầu tiên di chuyển tọa độ đầu và đuôi sẽ bị trùng. Nếu không chạy hàm move 1 lần trước thì hàm checkCollision sẽ true -> Game Over ngay từ đầu
	//Ve khung và con rắn
	S.Ve();
	B.veKhung();
	
	//Quản lý điểm số
	int score = 0;
	//Khai báo và khởi tạo các tham số để quản lý con mồi
	long long timeFood = 0;
	bool FoodAppear = false;
	bool ateFood = 1;
	Point foodPoint;
	//Bắt đầu game
	while (KB_CODE != KB_ESCAPE) {
		XoaManHinh();
		system("cls");
		//Xử lý con mồi (thức ăn)
		if (timeFood > 1000000)
			timeFood = 1;
		if (timeFood % 5 == 0) {
			timeFood++;
			srand(time(NULL));
			FoodAppear = true;
			do {
				foodPoint.x = 1 + rand() % 59;
				foodPoint.y = 1 + rand() % 19;
			} while (S.checkFoodCollision(foodPoint));
		}
		if (FoodAppear == true) {
			B.drawFood(foodPoint);
			if (S.ateFood(foodPoint)) {
				score += 1;
				S.growLength(foodPoint);
				FoodAppear = false;
			}
		}
		else
			timeFood++;
		if (_kbhit()) {
			KB_CODE = _getch();
			switch (KB_CODE) {
			case KB_UP: {
				huong = 1;
				break;
			}
			case KB_DOWN: {
				huong = 2;
				break;
			}
			case KB_LEFT: {
				huong = 3;
				break;
			}
			case KB_RIGHT: {
				huong = 4;
				break;
			}
			case KB_ESCAPE:
				break;
			}
			S.setDirection(huong);
		}
		B.veKhung();
		if (xuyenTuong == 1 && S.checkFrameConllision()) {
			S.goThroughWall();
			S.Ve();
		}
		else {
			S.Move();
			if (S.checkFrameConllision());
			else
				S.Ve();
		}
		B.drawScore(score);
		Sleep(speed);
		//Xử lý Game Over trong chế độ không xuyên tường
		if (xuyenTuong == 1) {
			if(S.checkCollision()) {
				gotoXY(width / 2, height / 2);
				cout << "GAME OVER!";
				break;
			}
		}
		else {
			if (S.checkCollision() || S.checkFrameConllision()) {
				gotoXY(width / 2, height / 2);
				cout << "GAME OVER!";
				break;
			}
		}
	}
}

int main() {
	SetConsoleOutputCP(65001); // ghi tiếng Việt
	//Chọn chế độ: xuyên tường hay không? Mặc định là không xuyên tường
	bool xuyenTuong = 0;
	//doKho: 1- dễ, 2- tb, 3- khó, độ khó = speed = thông số speed - Độ khó càng cao -> speed càng nhanh -> tham số 
	//truyền vào Sleep càng nhỏ
	int doKho;
	doKho = 1;
	INTRODUCTION I;
	int i = 2, t; // ghi lại i=1 để bắt đầu ở case 1 là xuất menu
	do
	{
		switch(i)
		{
		case 1:
			// xuất menu, thêm nhiều case nữa để xuất nhiều trang nha
			break;
		case 2:
			t = I.XuatChuThich(xuyenTuong);
			if (t == 0) i = 1; // quay lại xuất menu
			else i = 3;
			break;
		case 3:
			PlayGame(xuyenTuong, doKho);
			i = 4;
			break;
		// xuất lại menu
		case 4:
		// ai ghi case 4 kết thúc game giúp tui với
			break;
		}
	} while (i != 4);
	// ai ghi lại giúp tui nguyên cái hàm main càng tốt :))
	return 0;
}
